#!/usr/bin/env python3

import os.path
import sys
from visidata import Sheet, Column, ColumnAttr, run, status, Command, Path, ENTER, asyncthread
from visidata import namedlist, date, vlen, option, getGlobals, loadConfigFile, options
from visidata import unbindkey, globalCommand, BaseSheet, ColumnItem, domotd

import vgit

__version__ = 'v0.4-dev'
__version_info__ = 'saul.pw/vgit ' + __version__


option('config', '~/.vgitrc', 'config file to exec in Python')
options.motd_url = 'https://visidata.org/vgit/motd-' + __version__

GitRepo = namedlist('GitRepo', 'path stashes cached changes'.split())


@vgit.GitSheet.api
def git_exec(sheet, cmdstr):
    vd.push(TextSheet(cmdstr, sheet.git_lines(*cmdstr.split())))


def open_git(p):
    p.joinpath('.git').is_dir()
    return vgit.GitStatus(p)

def main():
    loadConfigFile(Path(options.config).resolve(), getGlobals())

    domotd()

    if len(sys.argv) > 1:
        topdir = Path(sys.argv[1])
    else:
        topdir = Path('.')

    if topdir.joinpath('.git').is_dir() or vgit.getRepoPath(topdir):
        vs = open_git(topdir)
    else:
        vs = GitOverview('gitrepos', source=topdir)

    run(vs)


unbindkey('gD')

globalCommand('gD', 'git-output', 'vd.push(vd.gitcmdlog)', 'show output of git commands this session')
globalCommand('gi', 'git-exec', 'sheet.git_exec(input("gi", type="git"))')

BaseSheet.addCommand('^A', 'git-abort', 'abortWhatever()', 'abort the current in-progress action')
BaseSheet.addCommand('L', 'git-log', 'vd.push(GitLogSheet(branch+"_log", ref=branch, source=sheet))', 'push log of current branch')

vgit.addGlobals(globals())

if __name__ == '__main__':
    status(__version_info__)
    rc = main()
    sys.exit(rc)
