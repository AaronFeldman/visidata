#!/usr/bin/env python3

import os.path
import sys
import subprocess
from visidata import Sheet, Column, ColumnAttr, run, status, Command, Path, ENTER, asyncthread
from visidata import option, loadConfigFile, options
from visidata import domotd, TextSheet

import vgit

__version__ = 'v0.4-dev'
__version_info__ = 'saul.pw/vgit ' + __version__


option('config', '~/.vgitrc', 'config file to exec in Python')
options.motd_url = 'https://visidata.org/vgit/motd-' + __version__
option('vgit_pager', False, 'fallback to pager instead of passthrough')


def somegit(args=None):
    cwd = Path('.')

    if cwd.joinpath('.git').is_dir() or vgit.getRepoPath(cwd):
        top = vgit.GitStatus(cwd)
    else:
        top = vgit.GitOverview('gitrepos', source=cwd)

    if not args:
        return top

    cmd = args[0]

    if cmd == 'grep':
        return vgit.GitGrep(args[1], regex=args[1], source=vgit.GitStatus(cwd))

    if cmd == 'status':
        return vgit.GitStatus(cwd)

    if cmd == 'log':
        return vgit.GitLogSheet(top.branch+"_log", ref=top.branch, source=top)



def main():
    loadConfigFile(options.config)

    args = sys.argv[1:]

    vs = somegit(args)

    if not vs and options.vgit_pager:
        cmdstr = ' '.join(args)
        vs = TextSheet(cmdstr, somegit().git_lines(*args))
    else:
        return subprocess.run(['git', *args]).returncode

    domotd()
    run(vs)


vgit.addGlobals(globals())

if __name__ == '__main__':
    status(__version_info__)
    rc = main()
    sys.exit(rc)
